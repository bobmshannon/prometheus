global:
  evaluation_interval: {{ .conf.prometheus.evaluation_interval }}
  scrape_interval: {{ .conf.prometheus.scrape_interval }}
  scrape_timeout: {{ .conf.prometheus.scrape_timeout }}

rule_files:
  {{ range .conf.prometheus.rule_files -}}
  - {{ . }}
  {{ end }}

scrape_configs:
  {{ if .conf.prometheus.custom_scrapes }}{{ range $.conf.prometheus.custom_scrapes }}
  - job_name: {{ .job_name }}
    metrics_path: {{ .metrics_path }}
    scheme: {{ .scheme }}
    static_configs:
      - targets:
        {{ range .static_configs }}{{ range .targets }}- {{ . }}{{ end }}{{ end }}
    tls_config:
      ca_file: {{ $.conf.prometheus.ca_file }}
      cert_file: {{ $.conf.prometheus.certificate_file }}
      key_file: {{ $.conf.prometheus.key_file }}
  {{ end }}{{ end -}}
  {{ if .conf.prometheus.prometheus_metrics }}{{ range $.conf.prometheus.prometheus_metrics }}
  - job_name: {{ .job_name }}
    metrics_path: {{ .metrics_path }}
    tls_config:
      ca_file: {{ $.conf.prometheus.ca_file }}
      cert_file: {{ $.conf.prometheus.certificate_file }}
      key_file: {{ $.conf.prometheus.key_file }}
    scheme: {{.scheme}}
    static_configs:
      - targets:
        {{ if .targets }}
        {{ range .targets -}}
        - {{ . }}
        {{ end -}}
        {{ else -}}
        {{ $targetPort := .port }}{{ range .hostnames }}- {{ . }}:{{ $targetPort }}
        {{ end -}}
        {{- end }}
    {{ if .basic_auth }}basic_auth:
      username: {{ .basic_auth.username }}
      password: {{ .basic_auth.password }}
    {{ end -}}
    {{ if .params }}params:
      {{ range $paramKey, $paramList := .params -}}
      {{ $paramKey }}:
        {{ range $paramList }}- {{ . }}
        {{ end }}
      {{ end -}}
    {{ end -}}
{{ end }}{{ end }}
alerting:
  alertmanagers:
    - scheme: {{.conf.prometheus.alertmanager_scheme}}
      path_prefix: {{ .conf.prometheus.alertmanager_path }}
      tls_config:
        ca_file: {{ $.conf.prometheus.ca_file }}
        cert_file: {{ $.conf.prometheus.certificate_file }}
        key_file: {{ $.conf.prometheus.key_file }}
      static_configs:
        - targets:
            {{ range .conf.prometheus.alertmanagers }}- {{ . }}
            {{ end }}
{{ if .conf.prometheus.custom_configs }}{{ .conf.prometheus.custom_configs }}{{ end }}